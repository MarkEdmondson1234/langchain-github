<!-- index.html -->
<!doctype html>
<html>
  <head>
    <title>Electric Sheep Brain - ReIndex</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script>
      function getLocalPath() {
        const repoInput = document.getElementById('hidden-repo-input');
        const fullPath = repoInput.files[0].webkitRelativePath.split('/');
        fullPath.pop();
        return fullPath.join('/');
      }

      function sendRequest(event) {
        event.preventDefault();

        // Show loading message
        const loadingMessage = document.getElementById('loading-message');
        loadingMessage.style.display = 'block';

        const localPath = getLocalPath();
        const ext = document.getElementById('ext').value;
        const ignore = document.getElementById('ignore').value;
        const resummarise = document.getElementById('resummarise').checked;

        const payload = {
          user_input: "Reindexed the database via webapp: " + localPath + ' files:' + ext,
          repo: localPath,
          reindex: true,
          ext: ext,
          ignore: ignore,
          resummarise: resummarise
        };

        fetch('/process_input', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        })
        .then(response => response.text())
        .then(data => {
            // Hide loading message
            loadingMessage.style.display = 'none';

            const outputElement = document.getElementById('output');
            const parsedData = JSON.parse(data);
            let htmlContent = `<h2>Bot Output:</h2><p>${parsedData.result}</p>`;

            if (parsedData.source_documents) {
                htmlContent += '<h3>Document Sources:</h3>';
                parsedData.source_documents.forEach((doc, index) => {
                htmlContent += `<h4>-- Source ${index + 1}</h4>`;
                htmlContent += `<p> - page_content: ${doc.page_content}</p>`;
                htmlContent += `<p> - metadata: ${JSON.stringify(doc.metadata)}</p>`;
                });
            }

            outputElement.innerHTML = htmlContent;
            }).catch(error => {
                console.error('Error:', error);
                // Hide loading message
                loadingMessage.style.display = 'none';
            });
      }
    </script>
    <style>
        #hidden-repo-input {
          display: none;
        }
        #select-folder-btn {
          cursor: pointer;
        }
      </style>
  </head>
  <body>
    <a href="/"><header>Electric Sheep Brain - Reindex</header></a>
    <!-- Navigation menu -->
    <nav>
        <ul class="nav">
            <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="reindex">Reindex</a></li>
        </ul>
    </nav>
    <div class="container">
        <form onsubmit="sendRequest(event)" class="row g-3">
            <div class="col-12">
                <label for="repo" class="form-label">Index data source directory</label>
                <div class="input-group">
                    <input type="file" name="repo" id="hidden-repo-input" webkitdirectory style="display: none;">
                    <button type="button" id="select-folder-btn" class="btn btn-secondary" onclick="document.getElementById('hidden-repo-input').click()">Select Folder</button>
                    <span id="selected-folder" class="form-text"></span>
                </div>
            </div>

            <div class="col-12">
                <label for="ext" class="form-label">File extensions to index from within data source</label>
                <input type="text" name="ext" id="ext" class="form-control" value=".py,.md,.txt">
            </div>

            <div class="col-12">
                <label for="ignore" class="form-label">Ignore all files in this folder</label>
                <input type="text" name="ignore" id="ignore" class="form-control" value="env/">
            </div>

            <div class="col-12">
                <div class="form-check">
                    <input type="checkbox" name="resummarise" id="resummarise" class="form-check-input">
                    <label for="resummarise" class="form-check-label">Regenerate summarise.md files (slow)</label>
                </div>
            </div>

            <div class="col-12">
                <button type="submit" class="btn btn-primary">Do a Reindex</button>
            </div>
        </form>
        <div id="loading-message" style="display:none;">
            <img src="{{ url_for('static', filename='loading.gif') }}" alt="Loading..." / width="400">
        </div>
    </div>
    <script>
        document.getElementById('hidden-repo-input').addEventListener('change', function() {
            const selectedFolder = getLocalPath();
            document.getElementById('selected-folder').textContent = selectedFolder;
        });
    </script>
    </body>
</html>